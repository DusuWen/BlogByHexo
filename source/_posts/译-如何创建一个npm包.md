---
title: è¯‘-å¦‚ä½•åˆ›å»ºä¸€ä¸ªnpmåŒ…
date: 2024-09-04 14:05:49
tags:
  - è¯‘
---

åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å°†åŒ…å‘ä¸åˆ°npmæ‰€éœ€çš„æ¯ä¸€æ­¥éª¤ã€‚

è¿™ä¸æ˜¯ä¸€ä¸ªæœ€ç®€æŒ‡å—ï¼Œæˆ‘ä»¬å°†ä»ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹å»ºç«‹ä¸€ä¸ªå®Œå…¨å¯ç”¨äºç”Ÿäº§ç¯å¢ƒçš„åŒ…ï¼ŒåŒ…æ‹¬
* Git ç”¨äºç‰ˆæœ¬æ§åˆ¶
* TypeScript ç”¨äºç¼–å†™ä»£ç å¹¶ä¿æŒç±»å‹å®‰å…¨ 
* Prettier ç”¨äºæ ¼å¼åŒ–æˆ‘ä»¬çš„ä»£ç 
* @arethetypeswrong/cli ç”¨äºæ£€æŸ¥æˆ‘ä»¬çš„å¯¼å‡º
* tsup ç”¨äºæŠŠæˆ‘ä»¬çš„ TypeScript ä»£ç ç¼–è¯‘ä¸º CJS å’Œ ESM
* Vitest ç”¨äºè¿è¡Œæµ‹è¯•
* GitHub Actions ç”¨äºè¿è¡Œ CI é›†æˆ
* Changesets ç”¨äºè®°å½•ç‰ˆæœ¬å’Œå‘å¸ƒåŒ…
<!-- more -->

## 1: Git
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ Git ä»“åº“ï¼Œè®¾ç½®ä¸€ä¸ª .gitignore æ–‡ä»¶ï¼Œè¿›è¡Œåˆæ¬¡æäº¤ï¼Œç„¶ååœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ï¼Œå¹¶å°†æˆ‘ä»¬çš„ä»£ç æ¨é€åˆ° GitHubã€‚

### 1.1 åˆå§‹åŒ–å·¥ç¨‹
æ‰§è¡Œä¸‹é¢å‘½ä»¤åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ git å·¥ç¨‹
```bash
git init
```

### 1.2 è®¾ç½®.gitignore
åœ¨ä½ çš„é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ª.gitignore æ–‡ä»¶å¹¶ä¸”æ·»åŠ ä»¥ä¸‹å†…å®¹
```
node_modules
```

### 1.3 åˆæ¬¡æäº¤
è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥è¿›è¡Œåˆæ¬¡æäº¤ï¼š
```bash
git add .
git commit -m "Initial commit"
```

### 1.4 åœ¨ GitHub åˆ›å»ºæ–°ä»“åº“
ä½¿ç”¨ GitHub CLIï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘é€‰æ‹©äº† `tt-package-demo` ä½œä¸ºä»“åº“åç§°ï¼š
```bash
gh repo create tt-package-demo --source=. --public
```

### 1.5 æ¨é€åˆ° GitHub
è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†ä»£ç æ¨é€åˆ° GitHubï¼š
```bash
git push --set-upstream origin main
```
## 2: `package.json`  
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªè®¸å¯è¯å­—æ®µï¼Œåˆ›å»ºä¸€ä¸ª `LICENSE` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª `README.md` æ–‡ä»¶ã€‚

### 2.1: åˆ›å»º `package.json` æ–‡ä»¶
åˆ›å»ºä¸€ä¸ª `package.json` æ–‡ä»¶ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "name": "tt-package-demo",
  "version": "1.0.0",
  "description": "A demo package for Total TypeScript",
  "keywords": ["demo", "typescript"],
  "homepage": "https://github.com/mattpocock/tt-package-demo",
  "bugs": {
    "url": "https://github.com/mattpocock/tt-package-demo/issues"
  },
  "author": "Matt Pocock <team@totaltypescript.com> (https://totaltypescript.com)",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/mattpocock/tt-package-demo.git"
  },
  "files": ["dist"],
  "type": "module"
}
```

- `name` æ˜¯äººä»¬å°†ç”¨æ¥å®‰è£…ä½ åŒ…çš„åç§°ã€‚å®ƒå¿…é¡»åœ¨ npm ä¸Šå”¯ä¸€ã€‚ä½ å¯ä»¥åˆ›å»ºç»„ç»‡ä½œç”¨åŸŸï¼ˆä¾‹å¦‚ `@total-typescript/demo`ï¼‰ï¼Œè¿™äº›ä½œç”¨åŸŸæ˜¯å…è´¹çš„ï¼Œå¯ä»¥å¸®åŠ©ä½¿å…¶å”¯ä¸€ã€‚
- `version` æ˜¯ä½ åŒ…çš„ç‰ˆæœ¬ã€‚å®ƒåº”è¯¥éµå¾ªè¯­ä¹‰ç‰ˆæœ¬æ§åˆ¶ï¼š`0.0.1` æ ¼å¼ã€‚æ¯æ¬¡å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œä½ åº”è¯¥å¢åŠ æ­¤æ•°å­—ã€‚
- `description` å’Œ `keywords` æ˜¯ä½ åŒ…çš„ç®€çŸ­æè¿°ã€‚å®ƒä»¬ä¼šåœ¨ npm æ³¨å†Œè¡¨ä¸­çš„æœç´¢ç»“æœä¸­åˆ—å‡ºã€‚
- `homepage` æ˜¯ä½ åŒ…ä¸»é¡µçš„ URLã€‚GitHub ä»“åº“æ˜¯ä¸€ä¸ªä¸é”™çš„é»˜è®¤é€‰æ‹©ï¼Œæˆ–è€…å¦‚æœä½ æœ‰æ–‡æ¡£ç½‘ç«™ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚
- `bugs` æ˜¯ç”¨æˆ·æŠ¥å‘ŠåŒ…é—®é¢˜çš„ URLã€‚
- `author` æ˜¯ä½ ï¼ä½ å¯ä»¥é€‰æ‹©æ·»åŠ ä½ çš„ç”µå­é‚®ä»¶å’Œç½‘ç«™ã€‚å¦‚æœä½ æœ‰å¤šä¸ªè´¡çŒ®è€…ï¼Œä½ å¯ä»¥æŒ‰ç…§ç›¸åŒçš„æ ¼å¼å°†ä»–ä»¬æŒ‡å®šä¸ºä¸€ä¸ªè´¡çŒ®è€…æ•°ç»„ã€‚
- `repository` æ˜¯ä½ åŒ…çš„ä»“åº“ URLã€‚è¿™å°†åœ¨ npm æ³¨å†Œè¡¨ä¸­åˆ›å»ºä¸€ä¸ªæŒ‡å‘ä½  GitHub ä»“åº“çš„é“¾æ¥ã€‚
- `files` æ˜¯ä¸€ä¸ªæ–‡ä»¶æ•°ç»„ï¼ŒæŒ‡æ˜äººä»¬å®‰è£…ä½ çš„åŒ…æ—¶åº”åŒ…å«çš„æ–‡ä»¶ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬åŒ…å«äº† `dist` æ–‡ä»¶å¤¹ã€‚`README.md`ã€`package.json` å’Œ `LICENSE` é»˜è®¤åŒ…å«åœ¨å†…ã€‚
- `type` è®¾ç½®ä¸º `module`ï¼Œä»¥è¡¨æ˜ä½ çš„åŒ…ä½¿ç”¨ ECMAScript æ¨¡å—ï¼Œè€Œä¸æ˜¯ CommonJS æ¨¡å—ã€‚

### 2.2: æ·»åŠ è®¸å¯è¯å­—æ®µ
å‘ä½ çš„ `package.json` æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ªè®¸å¯è¯å­—æ®µã€‚é€‰æ‹©ä¸€ä¸ªè®¸å¯è¯ç±»å‹ã€‚è¿™é‡Œé€‰æ‹©äº† MIT è®¸å¯è¯ã€‚

```json
{
  "license": "MIT"
}
```

### 2.3: æ·»åŠ  `LICENSE` æ–‡ä»¶
åˆ›å»ºä¸€ä¸ªåä¸º `LICENSE`ï¼ˆæ— æ‰©å±•åï¼‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ä½ çš„è®¸å¯è¯æ–‡æœ¬ã€‚å¯¹äº MIT è®¸å¯è¯ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
MIT License

Copyright (c) [year] [fullname]

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

å°† `[year]` å’Œ `[fullname]` å ä½ç¬¦æ›¿æ¢ä¸ºå½“å‰å¹´ä»½å’Œä½ çš„åå­—ã€‚

### 2.4: æ·»åŠ  `README.md` æ–‡ä»¶
åˆ›å»ºä¸€ä¸ª `README.md` æ–‡ä»¶ï¼Œæè¿°ä½ çš„åŒ…ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

```markdown
**tt-package-demo**

A demo package for Total TypeScript.
```

è¿™å°†åœ¨äººä»¬æŸ¥çœ‹ä½ çš„åŒ…æ—¶æ˜¾ç¤ºåœ¨ npm æ³¨å†Œè¡¨ä¸­ã€‚

## 3: TypeScript

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… TypeScriptï¼Œè®¾ç½® `tsconfig.json`ï¼Œåˆ›å»ºæºæ–‡ä»¶ï¼Œåˆ›å»ºç´¢å¼•æ–‡ä»¶ï¼Œè®¾ç½®æ„å»ºè„šæœ¬ï¼Œè¿è¡Œæ„å»ºï¼Œæ·»åŠ  `dist` åˆ° `.gitignore`ï¼Œè®¾ç½® CI è„šæœ¬ï¼Œå¹¶ä¸º DOM é…ç½®æˆ‘ä»¬çš„ `tsconfig.json`ã€‚


### 3.1: å®‰è£… TypeScript

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… TypeScriptï¼š

```bash
npm install --save-dev typescript
```

æˆ‘ä»¬æ·»åŠ  `--save-dev` æ˜¯å°† TypeScript å®‰è£…ä¸ºå¼€å‘ä¾èµ–ã€‚è¿™æ„å‘³ç€åœ¨ç”¨æˆ·å®‰è£…ä½ çš„åŒ…æ—¶ï¼ŒTypeScript ä¸ä¼šè¢«åŒ…å«å…¶ä¸­ã€‚


### 3.2: è®¾ç½® `tsconfig.json`

åˆ›å»ºä¸€ä¸ª `tsconfig.json` æ–‡ä»¶ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "compilerOptions": {
    /* åŸºæœ¬é€‰é¡¹ï¼š */
    "esModuleInterop": true,
    "skipLibCheck": true,
    "target": "es2022",
    "allowJs": true,
    "resolveJsonModule": true,
    "moduleDetection": "force",
    "isolatedModules": true,
    "verbatimModuleSyntax": true,

    /* ä¸¥æ ¼æ€§ */
    "strict": true,
    "noUncheckedIndexedAccess": true,
    "noImplicitOverride": true,

    /* å¦‚æœä½¿ç”¨ TypeScript è¿›è¡Œè½¬è¯‘ï¼š */
    "module": "NodeNext",
    "outDir": "dist",
    "rootDir": "src",
    "sourceMap": true,

    /* å¹¶ä¸”å¦‚æœä½ åœ¨æ„å»ºä¸€ä¸ªåº“ï¼š */
    "declaration": true,

    /* å¹¶ä¸”å¦‚æœä½ åœ¨å•ä»“åº“ä¸­æ„å»ºä¸€ä¸ªåº“ï¼š */
    "declarationMap": true
  }
}
```

è¿™äº›é€‰é¡¹åœ¨æˆ‘çš„ [TSConfig é€ŸæŸ¥è¡¨](é“¾æ¥) ä¸­æœ‰è¯¦ç»†è¯´æ˜ã€‚


### 3.3: ä¸º DOM é…ç½® `tsconfig.json`

å¦‚æœä½ çš„ä»£ç åœ¨ DOM ä¸­è¿è¡Œï¼ˆå³éœ€è¦è®¿é—® `document`ã€`window` æˆ– `localStorage` ç­‰ï¼‰ï¼Œè¯·è·³è¿‡æ­¤æ­¥éª¤ã€‚

å¦‚æœä½ çš„ä»£ç ä¸éœ€è¦è®¿é—® DOM APIï¼Œè¯·åœ¨ `tsconfig.json` ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "compilerOptions": {
    // ...å…¶ä»–é€‰é¡¹
    "lib": ["es2022"]
  }
}
```

è¿™å°†é˜²æ­¢ DOM ç±»å‹å®šä¹‰åœ¨ä½ çš„ä»£ç ä¸­å¯ç”¨ã€‚

å¦‚æœä½ ä¸ç¡®å®šï¼Œè·³è¿‡æ­¤æ­¥éª¤ã€‚


### 3.4: åˆ›å»ºæºæ–‡ä»¶

åˆ›å»ºä¸€ä¸ª `src/utils.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript
export const add = (a: number, b: number) => a + b;
```


### 3.5: åˆ›å»ºç´¢å¼•æ–‡ä»¶

åˆ›å»ºä¸€ä¸ª `src/index.ts` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```typescript
export { add } from "./utils.js";
```

`.js` æ‰©å±•åçœ‹èµ·æ¥æœ‰äº›å¥‡æ€ªã€‚æœ¬æ–‡ä¸­æœ‰æ›´å¤šè§£é‡Šã€‚


### 3.6: è®¾ç½®æ„å»ºè„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `scripts` å¯¹è±¡ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "build": "tsc"
  }
}
```

è¿™å°†ç¼–è¯‘ä½ çš„ TypeScript ä»£ç ä¸º JavaScriptã€‚


### 3.7: è¿è¡Œæ„å»º

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç¼–è¯‘ä½ çš„ TypeScript ä»£ç ï¼š

```bash
npm run build
```

è¿™å°†åˆ›å»ºä¸€ä¸ª `dist` æ–‡ä»¶å¤¹ï¼Œé‡Œé¢åŒ…å«ç¼–è¯‘åçš„ JavaScript ä»£ç ã€‚


### 3.8: å°† `dist` æ·»åŠ åˆ° `.gitignore`

åœ¨ä½ çš„ `.gitignore` æ–‡ä»¶ä¸­æ·»åŠ  `dist` æ–‡ä»¶å¤¹ï¼š

```
dist
```

è¿™å°†é˜²æ­¢ä½ çš„ç¼–è¯‘ä»£ç è¢«åŒ…å«åœ¨ Git ä»“åº“ä¸­ã€‚


### 3.9: è®¾ç½® CI è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `ci` è„šæœ¬ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "ci": "npm run build"
  }
}
```

è¿™ä¸ºåœ¨ CI ä¸Šè¿è¡Œæ‰€æœ‰å¿…è¦æ“ä½œæä¾›äº†ä¸€ä¸ªå¿«æ·æ–¹å¼ã€‚


è¿™æ ·ï¼Œä½ å·²ç»å®Œæˆäº† TypeScript çš„å®‰è£…å’Œé…ç½®ï¼Œè®¾ç½®äº†å¿…è¦çš„æ„å»ºè„šæœ¬ï¼Œå¹¶ç¡®ä¿ç¼–è¯‘åçš„ä»£ç ä¸ä¼šè¢«æäº¤åˆ° Git ä»“åº“ä¸­ã€‚

## 4: Prettier

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… Prettierï¼Œè®¾ç½® `.prettierrc` æ–‡ä»¶ï¼Œè®¾ç½®æ ¼å¼åŒ–è„šæœ¬ï¼Œè¿è¡Œæ ¼å¼åŒ–è„šæœ¬ï¼Œè®¾ç½®æ£€æŸ¥æ ¼å¼è„šæœ¬ï¼Œå°†æ£€æŸ¥æ ¼å¼è„šæœ¬æ·»åŠ åˆ° CI è„šæœ¬ä¸­ï¼Œå¹¶è¿è¡Œ CI è„šæœ¬ã€‚

Prettier æ˜¯ä¸€ä¸ªä»£ç æ ¼å¼åŒ–å·¥å…·ï¼Œå®ƒä¼šè‡ªåŠ¨å°†ä½ çš„ä»£ç æ ¼å¼åŒ–ä¸ºä¸€è‡´çš„é£æ ¼ï¼Œä»è€Œä½¿ä»£ç æ›´æ˜“äºé˜…è¯»å’Œç»´æŠ¤ã€‚


### 4.1: å®‰è£… Prettier

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… Prettierï¼š

```bash
npm install --save-dev prettier
```


### 4.2: è®¾ç½® `.prettierrc`

åˆ›å»ºä¸€ä¸ª `.prettierrc` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 80,
  "tabWidth": 2
}
```

ä½ å¯ä»¥åœ¨æ­¤æ–‡ä»¶ä¸­æ·»åŠ æ›´å¤šé€‰é¡¹ä»¥è‡ªå®šä¹‰ Prettier çš„è¡Œä¸ºã€‚å®Œæ•´çš„é€‰é¡¹åˆ—è¡¨å¯ä»¥åœ¨[è¿™é‡Œ](é“¾æ¥)æ‰¾åˆ°ã€‚


### 4.3: è®¾ç½®æ ¼å¼åŒ–è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `format` è„šæœ¬ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "format": "prettier --write ."
  }
}
```

è¿™å°†ä½¿ç”¨ Prettier æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶ã€‚


### 4.4: è¿è¡Œæ ¼å¼åŒ–è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ ¼å¼åŒ–é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼š

```bash
npm run format
```

ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸€äº›æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†å®ƒä»¬æäº¤ï¼š

```bash
git add .
git commit -m "Format code with Prettier"
```


### 4.5: è®¾ç½®æ£€æŸ¥æ ¼å¼è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `check-format` è„šæœ¬ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "check-format": "prettier --check ."
  }
}
```

è¿™å°†æ£€æŸ¥é¡¹ç›®ä¸­çš„æ‰€æœ‰æ–‡ä»¶æ˜¯å¦æ ¼å¼åŒ–æ­£ç¡®ã€‚


### 4.6: å°†å…¶æ·»åŠ åˆ° CI è„šæœ¬

åœ¨ `package.json` ä¸­çš„ CI è„šæœ¬ä¸­æ·»åŠ  `check-format` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "ci": "npm run build && npm run check-format"
  }
}
```

è¿™å°†ä½¿ `check-format` è„šæœ¬æˆä¸º CI è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚


é€šè¿‡è¿™äº›æ­¥éª¤ï¼Œä½ å·²ç»æˆåŠŸé…ç½®äº† Prettierï¼Œä»¥ç¡®ä¿ä½ çš„ä»£ç é£æ ¼ä¸€è‡´ï¼Œå¹¶å°†å…¶é›†æˆåˆ°äº† CI æµç¨‹ä¸­ã€‚

## 5: `exports`ã€`main` å’Œ `@arethetypeswrong/cli`

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å®‰è£… `@arethetypeswrong/cli`ï¼Œè®¾ç½® `check-exports` è„šæœ¬ï¼Œè¿è¡Œ `check-exports` è„šæœ¬ï¼Œè®¾ç½® `main` å­—æ®µï¼Œå†æ¬¡è¿è¡Œ `check-exports` è„šæœ¬ï¼Œè®¾ç½® CI è„šæœ¬å¹¶è¿è¡Œã€‚

`@arethetypeswrong/cli` æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºæ£€æŸ¥ä½ çš„åŒ…çš„å¯¼å‡ºæ˜¯å¦æ­£ç¡®ã€‚è¿™éå¸¸é‡è¦ï¼Œå› ä¸ºé”™è¯¯çš„å¯¼å‡ºä¼šå¯¼è‡´ä½¿ç”¨ä½ åŒ…çš„ç”¨æˆ·é‡åˆ°é—®é¢˜ã€‚


### 5.1: å®‰è£… `@arethetypeswrong/cli`

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… `@arethetypeswrong/cli`ï¼š

```bash
npm install --save-dev @arethetypeswrong/cli
```


### 5.2: è®¾ç½® `check-exports` è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `check-exports` è„šæœ¬ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "check-exports": "attw --pack ."
  }
}
```

è¿™å°†æ£€æŸ¥ä½ çš„åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ã€‚


### 5.3: è¿è¡Œ `check-exports` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```bash
npm run check-exports
```

ä½ åº”è¯¥ä¼šæ³¨æ„åˆ°å‡ºç°äº†å¤šä¸ªé”™è¯¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo"    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸ’€ Resolution failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸ’€ Resolution failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸ’€ Resolution failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸ’€ Resolution failed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™è¡¨æ˜æ²¡æœ‰ç‰ˆæœ¬çš„ Node æˆ–ä»»ä½•æ‰“åŒ…å·¥å…·èƒ½å¤Ÿä½¿ç”¨æˆ‘ä»¬çš„åŒ…ã€‚

è®©æˆ‘ä»¬æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚

---

### 5.4: è®¾ç½® `main` å­—æ®µ

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `main` å­—æ®µï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "main": "dist/index.js"
}
```

è¿™å‘Šè¯‰ Node åœ¨å“ªé‡Œæ‰¾åˆ°ä½ çš„åŒ…çš„å…¥å£ç‚¹ã€‚


### 5.5: å†æ¬¡è¿è¡Œ `check-exports` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤å†æ¬¡æ£€æŸ¥åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```bash
npm run check-exports
```

ä½ åº”è¯¥ä¼šæ³¨æ„åˆ°åªå‰©ä¸‹ä¸€ä¸ªè­¦å‘Šï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo"            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ âš ï¸ ESM (dynamic import only) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™è¡¨æ˜æˆ‘ä»¬çš„åŒ…ä¸è¿è¡Œ ESM çš„ç³»ç»Ÿå…¼å®¹ã€‚ä½¿ç”¨ CJS çš„äººï¼ˆé€šå¸¸åœ¨æ—§ç³»ç»Ÿä¸­ï¼‰éœ€è¦ä½¿ç”¨åŠ¨æ€å¯¼å…¥æ¥å¼•å…¥å®ƒã€‚

---

### 5.6: ä¿®å¤ CJS è­¦å‘Š

å¦‚æœä½ ä¸æƒ³æ”¯æŒ CJSï¼ˆæˆ‘æ¨èè¿™æ ·åšï¼‰ï¼Œå°† `check-exports` è„šæœ¬æ›´æ”¹ä¸ºï¼š

```json
{
  "scripts": {
    "check-exports": "attw --pack . --ignore-rules=cjs-resolves-to-esm"
  }
}
```

ç°åœ¨ï¼Œè¿è¡Œ `check-exports` å°†æ˜¾ç¤ºæ‰€æœ‰å†…å®¹éƒ½ä¸ºç»¿è‰²ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚æœä½ æ›´æ„¿æ„åŒæ—¶å‘å¸ƒ CJS å’Œ ESMï¼Œè¯·è·³è¿‡æ­¤æ­¥éª¤ã€‚


### 5.7: å°† `check-exports` è„šæœ¬æ·»åŠ åˆ° CI è„šæœ¬ä¸­

åœ¨ `package.json` ä¸­çš„ CI è„šæœ¬ä¸­æ·»åŠ  `check-exports` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports"
  }
}
```


é€šè¿‡è¿™äº›æ­¥éª¤ï¼Œä½ å·²ç»æˆåŠŸé…ç½®äº† `@arethetypeswrong/cli` æ¥æ£€æŸ¥åŒ…çš„å¯¼å‡ºï¼Œå¹¶å°†å…¶é›†æˆåˆ°äº† CI æµç¨‹ä¸­ï¼Œç¡®ä¿ä½ çš„åŒ…ä¸ä¸åŒçš„ç¯å¢ƒå…¼å®¹ã€‚
## 6: ä½¿ç”¨ `tsup` å®ç°åŒé‡å‘å¸ƒ

å¦‚æœä½ æƒ³å‘å¸ƒ CJS å’Œ ESM ä¸¤ç§æ ¼å¼çš„ä»£ç ï¼Œå¯ä»¥ä½¿ç”¨ `tsup`ã€‚`tsup` æ˜¯åŸºäº `esbuild` æ„å»ºçš„å·¥å…·ï¼Œå®ƒå¯ä»¥å°†ä½ çš„ TypeScript ä»£ç ç¼–è¯‘æˆä¸¤ç§æ ¼å¼ã€‚

æˆ‘çš„ä¸ªäººå»ºè®®æ˜¯è·³è¿‡æ­¤æ­¥éª¤ï¼Œåªå‘å¸ƒ ES Modulesã€‚è¿™æ ·å¯ä»¥ç®€åŒ–ä½ çš„è®¾ç½®ï¼Œé¿å…åŒé‡å‘å¸ƒå¸¦æ¥çš„é—®é¢˜ï¼Œå¦‚åŒåŒ…å±å®³ï¼ˆDual Package Hazardï¼‰ã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ æƒ³ç»§ç»­è¿›è¡Œï¼Œä»¥ä¸‹æ˜¯å…·ä½“æ­¥éª¤ã€‚


### 6.1: å®‰è£… `tsup`

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… `tsup`ï¼š

```bash
npm install --save-dev tsup
```


### 6.2: åˆ›å»º `tsup.config.ts` æ–‡ä»¶

åˆ›å»ºä¸€ä¸ª `tsup.config.ts` æ–‡ä»¶ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```typescript
import { defineConfig } from "tsup";

export default defineConfig({
  entryPoints: ["src/index.ts"],
  format: ["cjs", "esm"],
  dts: true,
  outDir: "dist",
  clean: true,
});
```

- `entryPoints` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒæŒ‡å®šä½ çš„åŒ…çš„å…¥å£ç‚¹ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `src/index.ts`ã€‚
- `format` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ŒæŒ‡å®šè¾“å‡ºçš„æ ¼å¼ã€‚æˆ‘ä»¬ä½¿ç”¨ `cjs`ï¼ˆCommonJSï¼‰å’Œ `esm`ï¼ˆECMAScript modulesï¼‰ã€‚
- `dts` æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå‘Šè¯‰ `tsup` ç”Ÿæˆå£°æ˜æ–‡ä»¶ã€‚
- `outDir` æ˜¯è¾“å‡ºç¼–è¯‘ä»£ç çš„ç›®å½•ã€‚
- `clean` å‘Šè¯‰ `tsup` åœ¨æ„å»ºä¹‹å‰æ¸…ç†è¾“å‡ºç›®å½•ã€‚


### 6.3: ä¿®æ”¹ `build` è„šæœ¬

åœ¨ `package.json` ä¸­å°† `build` è„šæœ¬ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "build": "tsup"
  }
}
```

æˆ‘ä»¬ç°åœ¨å°†ä½¿ç”¨ `tsup` ç¼–è¯‘ä»£ç ï¼Œè€Œä¸æ˜¯ `tsc`ã€‚


### 6.4: æ·»åŠ  `exports` å­—æ®µ

åœ¨ `package.json` ä¸­æ·»åŠ  `exports` å­—æ®µï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "exports": {
    "./package.json": "./package.json",
    ".": {
      "import": "./dist/index.js",
      "default": "./dist/index.cjs"
    }
  }
}
```

`exports` å­—æ®µå‘Šè¯‰ä½¿ç”¨ä½ çš„åŒ…çš„ç¨‹åºå¦‚ä½•æ‰¾åˆ° CJS å’Œ ESM ç‰ˆæœ¬ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ `import` çš„ç”¨æˆ·æŒ‡å‘ `dist/index.js`ï¼Œå°†ä½¿ç”¨ `require` çš„ç”¨æˆ·æŒ‡å‘ `dist/index.cjs`ã€‚

å»ºè®®å°† `./package.json` ä¹Ÿæ·»åŠ åˆ° `exports` å­—æ®µä¸­ï¼Œå› ä¸ºæŸäº›å·¥å…·éœ€è¦è½»æ¾è®¿é—®ä½ çš„ `package.json` æ–‡ä»¶ã€‚


### 6.5: å†æ¬¡è¿è¡Œ `check-exports` è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ£€æŸ¥åŒ…çš„æ‰€æœ‰å¯¼å‡ºæ˜¯å¦æ­£ç¡®ï¼š

```bash
npm run check-exports
```

ç°åœ¨ï¼Œæ‰€æœ‰å†…å®¹éƒ½æ˜¾ç¤ºä¸ºç»¿è‰²ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚ "tt-package-demo" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node10            â”‚ ğŸŸ¢                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from CJS) â”‚ ğŸŸ¢ (CJS)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node16 (from ESM) â”‚ ğŸŸ¢ (ESM)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bundler           â”‚ ğŸŸ¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 6.6: å°† TypeScript ç”¨ä½œ Linter

ç”±äºæˆ‘ä»¬ä¸å†ä½¿ç”¨ `tsc` æ¥ç¼–è¯‘ä»£ç ï¼Œè€Œ `tsup` ä¹Ÿä¸ä¼šæ£€æŸ¥ä»£ç ä¸­çš„é”™è¯¯ï¼ˆå®ƒåªæ˜¯å°†ä»£ç è½¬æ¢ä¸º JavaScriptï¼‰ï¼Œè¿™æ„å‘³ç€å¦‚æœæˆ‘ä»¬çš„ä»£ç ä¸­å­˜åœ¨ TypeScript é”™è¯¯ï¼ŒCI è„šæœ¬ä¸ä¼šæŠ¥é”™ã€‚

è®©æˆ‘ä»¬ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚


#### 6.6.1: åœ¨ `tsconfig.json` ä¸­æ·»åŠ  `noEmit`

åœ¨ `tsconfig.json` ä¸­æ·»åŠ  `noEmit` å­—æ®µï¼š

```json
{
  "compilerOptions": {
    // ...other options
    "noEmit": true
  }
}
```


#### 6.6.2: åˆ é™¤ `tsconfig.json` ä¸­æœªä½¿ç”¨çš„å­—æ®µ

ä» `tsconfig.json` ä¸­åˆ é™¤ä»¥ä¸‹å­—æ®µï¼š

- `outDir`
- `rootDir`
- `sourceMap`
- `declaration`
- `declarationMap`

åœ¨æˆ‘ä»¬çš„æ–° `linting` è®¾ç½®ä¸­ï¼Œè¿™äº›å­—æ®µå·²ä¸å†éœ€è¦ã€‚


#### 6.6.3: å¯é€‰ï¼šå°† `module` æ”¹ä¸º `Preserve`

å¯é€‰åœ°ï¼Œä½ ç°åœ¨å¯ä»¥å°† `module` æ›´æ”¹ä¸º `Preserve`ï¼š

```json
{
  "compilerOptions": {
    // ...other options
    "module": "Preserve"
  }
}
```

è¿™æ„å‘³ç€ä½ å°†ä¸å†éœ€è¦ä½¿ç”¨ `.js` æ‰©å±•åæ¥å¯¼å…¥æ–‡ä»¶ã€‚è¿™æ„å‘³ç€ `index.ts` å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
export * from "./utils";
```


#### 6.6.4: æ·»åŠ  `lint` è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `lint` è„šæœ¬ï¼Œå¹¶å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "scripts": {
    "lint": "tsc"
  }
}
```

è¿™å°†è¿è¡Œ TypeScript ä½œä¸º linterã€‚


#### 6.6.5: å°† `lint` æ·»åŠ åˆ° CI è„šæœ¬ä¸­

åœ¨ `package.json` ä¸­çš„ CI è„šæœ¬ä¸­æ·»åŠ  `lint` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports && npm run lint"
  }
}
```


ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ CI è¿‡ç¨‹ä¸­æ•è· TypeScript é”™è¯¯ã€‚é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å·²ç»æˆåŠŸé…ç½®äº† `tsup` æ¥å®ç° CJS å’Œ ESM çš„åŒé‡å‘å¸ƒï¼Œå¹¶å°† TypeScript ä½œä¸º linter é›†æˆåˆ° CI æµç¨‹ä¸­ã€‚

## 7: ä½¿ç”¨ Vitest è¿›è¡Œæµ‹è¯•

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®‰è£… Vitestï¼Œåˆ›å»ºæµ‹è¯•ï¼Œè®¾ç½®æµ‹è¯•è„šæœ¬ï¼Œè¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œè®¾ç½®å¼€å‘è„šæœ¬ï¼Œå¹¶å°†æµ‹è¯•è„šæœ¬æ·»åŠ åˆ°æˆ‘ä»¬çš„ CI è„šæœ¬ä¸­ã€‚Vitest æ˜¯ä¸€ä¸ªç°ä»£çš„æµ‹è¯•è¿è¡Œå™¨ï¼Œæ”¯æŒ ESM å’Œ TypeScriptï¼Œç±»ä¼¼äº Jestï¼Œä½†æ›´è½»ä¾¿å’Œé«˜æ•ˆã€‚


### 7.1: å®‰è£… Vitest

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£… Vitestï¼š

```bash
npm install --save-dev vitest
```


### 7.2: åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶

åœ¨ `src/utils.test.ts` æ–‡ä»¶ä¸­ç¼–å†™ä»¥ä¸‹å†…å®¹ï¼š

```typescript
import { add } from "./utils.js";
import { test, expect } from "vitest";

test("add", () => {
  expect(add(1, 2)).toBe(3);
});
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œå®ƒæ£€æŸ¥ `add` å‡½æ•°æ˜¯å¦è¿”å›æ­£ç¡®çš„å€¼ã€‚


### 7.3: è®¾ç½®æµ‹è¯•è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ ä»¥ä¸‹ `test` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "test": "vitest run"
  }
}
```

`vitest run` å°†åœ¨é¡¹ç›®ä¸­è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œä¸”ä¸ä¼šè¿›è¡Œæ–‡ä»¶ç›‘å¬ã€‚


### 7.4: è¿è¡Œæµ‹è¯•è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥æ‰§è¡Œæµ‹è¯•ï¼š

```bash
npm run test
```

ä½ åº”è¯¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š

```
 âœ“ src/utils.test.ts (1)
   âœ“ add

 Test Files  1 passed (1)
      Tests  1 passed (1)
```

è¿™è¡¨æ˜ä½ çš„æµ‹è¯•æˆåŠŸé€šè¿‡ã€‚


### 7.5: è®¾ç½®å¼€å‘è„šæœ¬

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸ä¼šè¿è¡Œæµ‹è¯•å¹¶è®©å®ƒç›‘å¬æ–‡ä»¶çš„å˜åŒ–ã€‚ä¸ºæ­¤ï¼Œåœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ª `dev` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "dev": "vitest"
  }
}
```

è¿™å°†ä½¿ Vitest è¿›å…¥æ–‡ä»¶ç›‘å¬æ¨¡å¼ï¼Œä¾¿äºå¼€å‘æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•ã€‚


### 7.6: å°†æµ‹è¯•è„šæœ¬æ·»åŠ åˆ° CI è„šæœ¬

åœ¨ `package.json` ä¸­ï¼Œå°† `test` è„šæœ¬æ·»åŠ åˆ° CI æµç¨‹ä¸­ï¼š

```json
{
  "scripts": {
    "ci": "npm run build && npm run check-format && npm run check-exports && npm run lint && npm run test"
  }
}
```


ç°åœ¨ï¼Œä½ å·²ç»æˆåŠŸé›†æˆäº† Vitest è¿›è¡Œæµ‹è¯•ï¼Œå¹¶ç¡®ä¿æµ‹è¯•ä¼šä½œä¸º CI æµç¨‹çš„ä¸€éƒ¨åˆ†è¿›è¡Œã€‚é€šè¿‡æ–‡ä»¶ç›‘å¬æ¨¡å¼ï¼Œä½ å¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­å®æ—¶æ£€æŸ¥ä»£ç çš„æ­£ç¡®æ€§ã€‚
## 8: Set up CI with GitHub Actions

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª GitHub Actions å·¥ä½œæµï¼Œåœ¨æ¯æ¬¡æäº¤å’Œæ‹‰å–è¯·æ±‚æ—¶è¿è¡Œ CI æµç¨‹ã€‚è¿™æ˜¯ç¡®ä¿æˆ‘ä»¬çš„åŒ…å§‹ç»ˆå¤„äºæ­£å¸¸å·¥ä½œçŠ¶æ€çš„é‡è¦æ­¥éª¤ã€‚


### 8.1: åˆ›å»ºå·¥ä½œæµ

åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»º `.github/workflows/ci.yml` æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```yaml
name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install

      - name: Run CI
        run: npm run ci
```

è¿™ä¸ªæ–‡ä»¶ä¸º GitHub æä¾›äº†è¿è¡Œ CI æµç¨‹çš„æŒ‡ä»¤ã€‚

- **name**ï¼šå®šä¹‰å·¥ä½œæµçš„åç§°ä¸º `CI`ã€‚
- **on**ï¼šæŒ‡å®šå·¥ä½œæµä½•æ—¶è¿è¡Œã€‚è¿™é‡Œè®¾ç½®ä¸ºåœ¨ `main` åˆ†æ”¯ä¸Šçš„æ¯æ¬¡æäº¤å’Œæ‹‰å–è¯·æ±‚æ—¶è¿è¡Œã€‚
- **concurrency**ï¼šç¡®ä¿åŒä¸€åˆ†æ”¯ä¸Šä¸ä¼šåŒæ—¶è¿è¡Œå¤šä¸ªå·¥ä½œæµå®ä¾‹ï¼Œ`cancel-in-progress` å‚æ•°ç”¨æ¥å–æ¶ˆæ­£åœ¨è¿è¡Œçš„æ—§å®ä¾‹ã€‚
- **jobs**ï¼šå®šä¹‰è¦è¿è¡Œçš„ä¸€ç»„ä»»åŠ¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º `ci` çš„ä»»åŠ¡ã€‚
- **actions/checkout@v4**ï¼šæ‹‰å–ä»£ç åˆ°å·¥ä½œç¯å¢ƒã€‚
- **actions/setup-node@v4**ï¼šè®¾ç½® Node.js å’Œ npm ç¯å¢ƒã€‚
- **npm install**ï¼šå®‰è£…é¡¹ç›®ä¾èµ–ã€‚
- **npm run ci**ï¼šè¿è¡Œé¡¹ç›®çš„ CI è„šæœ¬ã€‚

å¦‚æœ CI è¿‡ç¨‹ä¸­çš„ä»»ä½•éƒ¨åˆ†å¤±è´¥ï¼ŒGitHub å°†åœ¨æäº¤æ—è¾¹æ˜¾ç¤ºçº¢è‰²çš„ "X"ï¼Œè¡¨ç¤ºå·¥ä½œæµå¤±è´¥ã€‚


### 8.2: æµ‹è¯•å·¥ä½œæµ

å°†ä½ çš„æ›´æ”¹æ¨é€åˆ° GitHubï¼Œç„¶åæ£€æŸ¥ä»“åº“çš„ **Actions** é€‰é¡¹å¡ã€‚ä½ åº”è¯¥ä¼šçœ‹åˆ°å·¥ä½œæµæ­£åœ¨è¿è¡Œã€‚

è¿™ç¡®ä¿æ¯æ¬¡æäº¤å’Œæ¯ä¸ªæ‹‰å–è¯·æ±‚éƒ½å°†è‡ªåŠ¨è§¦å‘ CI æµç¨‹ï¼Œä¸ºä½ æä¾›å¯¹ä»£ç çš„æŒç»­æ£€æŸ¥ä¸åé¦ˆã€‚

## 9: Publishing with Changesets

åœ¨è¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å®‰è£… Changesetsã€åˆå§‹åŒ–å®ƒã€è®¾ç½®å‘å¸ƒè„šæœ¬ï¼Œå¹¶æœ€ç»ˆå°†åŒ…å‘å¸ƒåˆ° npmã€‚Changesets æ˜¯ä¸€ä¸ªå¸®åŠ©ä½ ç‰ˆæœ¬åŒ–å¹¶å‘å¸ƒåŒ…çš„å·¥å…·ï¼Œéå¸¸é€‚åˆå°†ä»£ç å‘å¸ƒåˆ° npmã€‚


### 9.1: å®‰è£… @changesets/cli

è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… Changesets CLIï¼š

```bash
npm install --save-dev @changesets/cli
```


### 9.2: åˆå§‹åŒ– Changesets

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥åˆå§‹åŒ– Changesetsï¼š

```bash
npx changeset init
```

æ­¤å‘½ä»¤å°†åˆ›å»ºä¸€ä¸ª `.changeset` æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å« `config.json` æ–‡ä»¶ï¼Œä½ çš„ changeset å°†å­˜å‚¨åœ¨æ­¤æ–‡ä»¶å¤¹ä¸­ã€‚


### 9.3: è®¾ç½® Changeset å‘å¸ƒä¸ºå…¬å¼€

åœ¨ `.changeset/config.json` ä¸­ï¼Œå°† `access` å­—æ®µä¿®æ”¹ä¸º `public`ï¼š

```json
{
  "access": "public"
}
```

è¿™ä¸€æ­¥ç¡®ä¿ä½ çš„åŒ…èƒ½å¤Ÿå…¬å¼€å‘å¸ƒåˆ° npmã€‚


### 9.4: å°† commit è®¾ç½®ä¸º true

åœ¨ `.changeset/config.json` ä¸­ï¼Œå°† `commit` å­—æ®µè®¾ç½®ä¸º `true`ï¼š

```json
{
  "commit": true
}
```

è¿™æ ·åœ¨ç‰ˆæœ¬å‘å¸ƒåï¼Œchangeset ä¼šè‡ªåŠ¨æäº¤åˆ°ä½ çš„ä»£ç åº“ã€‚


### 9.5: è®¾ç½® local-release è„šæœ¬

åœ¨ `package.json` ä¸­æ·»åŠ  `local-release` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "local-release": "changeset version && changeset publish"
  }
}
```

è¿™ä¸ªè„šæœ¬å°†è¿è¡Œä½ çš„ CI æµç¨‹å¹¶å‘å¸ƒåŒ…åˆ° npmï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œæ­¤å‘½ä»¤å‘å¸ƒæ–°çš„ç‰ˆæœ¬ã€‚


### 9.6: åœ¨ `prepublishOnly` ä¸­è¿è¡Œ CI

åœ¨ `package.json` ä¸­æ·»åŠ  `prepublishOnly` è„šæœ¬ï¼š

```json
{
  "scripts": {
    "prepublishOnly": "npm run ci"
  }
}
```

è¿™ä¼šåœ¨å‘å¸ƒåŒ…ä¹‹å‰è‡ªåŠ¨è¿è¡Œ CI æµç¨‹ï¼Œç¡®ä¿ä»£ç æ²¡æœ‰é—®é¢˜ã€‚


### 9.7: æ·»åŠ  changeset

è¿è¡Œä»¥ä¸‹å‘½ä»¤æ·»åŠ  changesetï¼š

```bash
npx changeset
```

è¿™ä¼šæ‰“å¼€ä¸€ä¸ªäº¤äº’å¼æç¤ºï¼Œå¸®åŠ©ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„ changesetã€‚ä½ å¯ä»¥å°†è¿™ä¸ªå‘å¸ƒæ ‡è®°ä¸º `patch` ç‰ˆæœ¬ï¼Œå¹¶æ·»åŠ ç±»ä¼¼äº "Initial release" çš„æè¿°ã€‚


### 9.8: æäº¤ä½ çš„æ›´æ”¹

å°†æ›´æ”¹æäº¤åˆ°ä»£ç åº“ï¼š

```bash
git add .
git commit -m "Prepare for initial release"
```


### 9.9: è¿è¡Œ local-release è„šæœ¬

è¿è¡Œä»¥ä¸‹å‘½ä»¤å‘å¸ƒä½ çš„åŒ…ï¼š

```bash
npm run local-release
```

è¿™ä¸ªå‘½ä»¤ä¼šè¿è¡Œ CI æµç¨‹ã€ç‰ˆæœ¬åŒ–åŒ…å¹¶å‘å¸ƒåˆ° npmã€‚åœ¨ä»£ç åº“ä¸­è¿˜ä¼šåˆ›å»ºä¸€ä¸ª `CHANGELOG.md` æ–‡ä»¶ï¼Œè¯¦ç»†è¯´æ˜æ¯æ¬¡å‘å¸ƒçš„æ›´æ”¹ã€‚


### 9.10: æŸ¥çœ‹ä½ çš„åŒ…

æ‰“å¼€ä»¥ä¸‹åœ°å€æŸ¥çœ‹ä½ çš„åŒ…ï¼š

```text
http://npmjs.com/package/<your-package-name>
```

æ­å–œä½ ï¼ä½ å·²ç»æˆåŠŸå°†åŒ…å‘å¸ƒåˆ° npmã€‚

## æ€»ç»“

ç°åœ¨ï¼Œä½ å·²ç»å®Œæˆäº†åŒ…çš„å®Œæ•´è®¾ç½®ï¼ŒåŒ…å«äº†ï¼š

- TypeScript é¡¹ç›®é…ç½®
- Prettierï¼Œç”¨äºæ ¼å¼åŒ–å’Œæ£€æŸ¥ä»£ç æ ¼å¼
- @arethetypeswrong/cliï¼Œç”¨äºæ£€æŸ¥åŒ…çš„å¯¼å‡ºæ˜¯å¦æ­£ç¡®
- tsupï¼Œç”¨äºå°† TypeScript ç¼–è¯‘ä¸º JavaScript
- vitestï¼Œç”¨äºè¿è¡Œæµ‹è¯•
- GitHub Actionsï¼Œç”¨äº CI æµç¨‹
- Changesetsï¼Œç”¨äºç‰ˆæœ¬åŒ–å’Œå‘å¸ƒåŒ…

åç»­è¿˜å¯ä»¥è®¾ç½® Changesets GitHub action å’Œ PR botï¼Œè®©è´¡çŒ®è€…åœ¨æäº¤ PR æ—¶è‡ªåŠ¨æ¨èæ·»åŠ  changesetã€‚å¦‚æœä½ è¿˜æœ‰é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼
